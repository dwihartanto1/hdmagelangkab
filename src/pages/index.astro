---
// src/pages/index.astro
import { contentfulClient } from "../lib/contentful";
import type { School } from "../lib/contentful";
import "../styles/global.css";

let schoolsByCategory = {} as Record<string, School['fields'][]>;

try {
  const entries = await contentfulClient.getEntries<School>({
    content_type: "card",
  });

  // Group schools by category
  schoolsByCategory = entries.items.reduce((acc, item) => {
    const category = item.fields.kategori || 'Uncategorized';
    if (!acc[category]) acc[category] = [];
    acc[category].push(item.fields);
    return acc;
  }, {} as Record<string, School['fields'][]>);
} catch (error) {
  console.error("Error fetching schools:", error);
  // Placeholder data for development
  schoolsByCategory = {
    "BA": [
      { namaMadrasah: "BA Aisyiyah", kategori: "BA", logo: { fields: { file: { url: "/placeholder-logo.svg" } } }, linkRdm: "https://example.com" },
    ],
    "RA": [
      { namaMadrasah: "RA Al-Hidayah", kategori: "RA", logo: { fields: { file: { url: "/placeholder-logo.svg" } } }, linkRdm: "https://example.com" },
    ],
    "MI": [
      { namaMadrasah: "MI Islamiyah", kategori: "MI", logo: { fields: { file: { url: "/placeholder-logo.svg" } } }, linkRdm: "https://example.com" },
    ],
    "MTs": [
      { namaMadrasah: "MTs Negeri Magelang", kategori: "MTs", logo: { fields: { file: { url: "/placeholder-logo.svg" } } }, linkRdm: "https://example.com" },
    ],
    "MA": [
      { namaMadrasah: "MA Al-Muhajirin", kategori: "MA", logo: { fields: { file: { url: "/placeholder-logo.svg" } } }, linkRdm: "https://example.com" },
    ],
  };
}
---

<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <title>HD Magelang — Daftar Madrasah</title>
  </head>
  <body class="font-sans text-slate-900 bg-slate-50/50 selection:bg-emerald-100 selection:text-emerald-900">
    <div class="min-h-screen flex flex-col">
      {/* Top Navigation / Header */}
      <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16 md:h-20">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200">
                <img src="/placeholder-logo.svg" alt="Logo" class="w-6 h-6 brightness-0 invert" />
              </div>
              <div>
                <span class="text-xl font-black tracking-tight text-slate-900">HD<span class="text-emerald-600">MAGELANG</span></span>
              </div>
            </div>
            
            <div class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-600">
              <a href="/" class="text-emerald-600 font-bold">Beranda</a>
              <a href="/about" class="hover:text-emerald-600 transition-colors">Tentang</a>
              <a href="#" class="px-4 py-2 bg-slate-900 text-white rounded-full hover:bg-slate-800 transition-all shadow-md">Kontak Kami</a>
            </div>
          </div>
        </div>
      </header>

      {/* Hero Section */}
      <section class="relative py-12 md:py-20 overflow-hidden">
        <div class="absolute inset-0 -z-10">
          <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-96 bg-emerald-400/10 blur-[120px] rounded-full"></div>
        </div>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h1 class="text-4xl md:text-6xl font-black text-slate-900 mb-6 tracking-tight">
            Direktori <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500">Madrasah Digital</span>
          </h1>
          <p class="text-lg md:text-xl text-slate-600 max-w-2xl mx-auto mb-10 leading-relaxed">
            Akses cepat ke layanan RDM dan website resmi Madrasah di seluruh Kabupaten Magelang dalam satu pintu.
          </p>

          {/* Search Bar */}
          <div class="max-w-2xl mx-auto relative group">
            <div class="absolute inset-y-0 left-5 flex items-center pointer-events-none">
              <svg class="w-5 h-5 text-slate-400 group-focus-within:text-emerald-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input 
              id="search" 
              type="search" 
              placeholder="Cari nama madrasah (contoh: MTsN 1 Magelang)..." 
              class="w-full pl-14 pr-6 py-4 md:py-5 bg-white border border-slate-200 rounded-2xl shadow-xl shadow-slate-200/50 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-lg"
            />
          </div>
        </div>
      </section>

      {/* Main Content */}
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-24 flex-grow">
        {/* Filter Tabs */}
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
          <nav class="category-nav flex flex-wrap gap-2 p-1.5 bg-slate-200/50 rounded-2xl w-fit" aria-label="Kategori">
            <button class="cat active px-6 py-2.5 rounded-xl text-sm font-bold transition-all" data-cat="all">Semua</button>
            <button class="cat px-6 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-slate-900 transition-all" data-cat="BA">BA</button>
            <button class="cat px-6 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-slate-900 transition-all" data-cat="RA">RA</button>
            <button class="cat px-6 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-slate-900 transition-all" data-cat="MI">MI</button>
            <button class="cat px-6 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-slate-900 transition-all" data-cat="MTs">MTs</button>
            <button class="cat px-6 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-slate-900 transition-all" data-cat="MA">MA</button>
          </nav>
          <div class="text-sm text-slate-500 font-medium">
            Menampilkan <span class="text-slate-900 font-bold">Kabupaten Magelang</span>
          </div>
        </div>

        {Object.entries(schoolsByCategory).map(([category, schools]) => (
          <section data-category={category} class="mb-16 last:mb-0">
            <div class="flex items-center gap-4 mb-8">
              <h2 class="text-2xl font-black text-slate-900 uppercase tracking-wider">{category}</h2>
              <div class="h-px flex-grow bg-slate-200"></div>
              <span class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">{schools.length} Sekolah</span>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8">
              {schools.map((school) => (
                <a 
                  href={school.linkRdm} 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  class="school-card group relative bg-white border border-slate-200 rounded-3xl p-6 transition-all duration-300 hover:border-emerald-500 hover:shadow-2xl hover:shadow-emerald-100 hover:-translate-y-2 flex flex-col h-full"
                  data-name={school.namaMadrasah} 
                  data-category={category}
                >
                  <div class="mb-6 relative">
                    <div class="w-16 h-16 rounded-2xl bg-slate-50 flex items-center justify-center group-hover:scale-110 transition-transform duration-500 overflow-hidden border border-slate-100">
                      <img 
                        class="w-10 h-10 object-contain" 
                        src={school.logo?.fields?.file?.url ?? '/placeholder-logo.svg'} 
                        alt={school.namaMadrasah} 
                      />
                    </div>
                    <div class="absolute -top-2 -right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <div class="bg-emerald-500 text-white p-1.5 rounded-full shadow-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                      </div>
                    </div>
                  </div>

                  <div class="flex-grow">
                    <h3 class="text-lg font-bold text-slate-900 leading-snug group-hover:text-emerald-600 transition-colors mb-2">
                      {school.namaMadrasah}
                    </h3>
                    <div class="flex items-center gap-2">
                      <span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>
                      <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">{category}</span>
                    </div>
                  </div>

                  <div class="mt-6 pt-6 border-t border-slate-50 flex items-center justify-between">
                    <span class="text-sm font-bold text-slate-900 group-hover:translate-x-1 transition-transform">Kunjungi Website</span>
                    <svg class="w-5 h-5 text-slate-300 group-hover:text-emerald-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                  </div>
                </a>
              ))}
            </div>
          </section>
        ))}
      </main>

      {/* Footer */}
      <footer class="bg-slate-900 text-slate-400 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <div class="flex items-center justify-center gap-2 mb-6">
            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center">
              <img src="/placeholder-logo.svg" alt="Logo" class="w-5 h-5 brightness-0 invert" />
            </div>
            <span class="text-lg font-black text-white tracking-tight">HD MAGELANG</span>
          </div>
          <p class="text-sm mb-8">Portal Informasi Madrasah Kabupaten Magelang</p>
          <div class="h-px bg-slate-800 w-full max-w-xs mx-auto mb-8"></div>
          <p class="text-xs uppercase tracking-[0.2em] font-bold">
            © {new Date().getFullYear()} — Dikelola oleh Tim HD Magelang
          </p>
        </div>
      </footer>
    </div>

    <script>
      // Simple client-side filtering
      (function(){
        const search = document.getElementById('search') as HTMLInputElement;
        const cards = () => Array.from(document.querySelectorAll('.school-card')) as HTMLElement[];
        const catButtons = Array.from(document.querySelectorAll('.category-nav .cat')) as HTMLElement[];

        function filterCards() {
          const q = (search.value || '').trim().toLowerCase();
          const activeCat = document.querySelector('.category-nav .cat.active')?.getAttribute('data-cat') || 'all';

          cards().forEach(card => {
            const name = (card.getAttribute('data-name') || '').toLowerCase();
            const cat = card.getAttribute('data-category') || '';
            const matchesText = q === '' || name.includes(q);
            const matchesCat = activeCat === 'all' || cat === activeCat;
            
            if (matchesText && matchesCat) {
              card.style.display = 'flex';
              card.style.opacity = '1';
            } else {
              card.style.display = 'none';
              card.style.opacity = '0';
            }
          });

          // Hide empty sections
          document.querySelectorAll('section[data-category]').forEach(section => {
            const visibleCards = (section as HTMLElement).querySelectorAll('.school-card[style*="display: flex"]');
            (section as HTMLElement).style.display = visibleCards.length > 0 ? 'block' : 'none';
          });
        }

        search?.addEventListener('input', filterCards);

        catButtons.forEach(btn => btn.addEventListener('click', () => {
          catButtons.forEach(b => b.classList.remove('active', 'bg-white', 'text-emerald-600', 'shadow-sm', 'ring-1', 'ring-slate-200'));
          catButtons.forEach(b => b.classList.add('text-slate-600'));
          
          btn.classList.add('active', 'bg-white', 'text-emerald-600', 'shadow-sm', 'ring-1', 'ring-slate-200');
          btn.classList.remove('text-slate-600');
          filterCards();
        }));
      })();
    </script>
  </body>
</html>